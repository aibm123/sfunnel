<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Credential Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --background: #111827;
            --sidebar: #1f2937;
            --border: #374151;
            --text-primary: #d1d5db;
            --text-secondary: #9ca3af;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--background); color: var(--text-primary); }
        .nav-link { color: var(--text-secondary); transition: all 0.2s ease-in-out; border-bottom: 2px solid transparent; }
        .nav-link:hover { color: #ffffff; border-bottom-color: var(--primary-hover); }
        .nav-link.active { color: #ffffff; font-weight: 600; border-bottom-color: var(--primary); }
        .card { background-color: var(--sidebar); border: 1px solid var(--border); }
        .btn-primary { background-color: var(--primary); color: #ffffff; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-primary:disabled { background-color: #1e3a8a; cursor: not-allowed; opacity: 0.7; }
        .input-field { background-color: var(--border); border: 1px solid #4b5563; color: var(--text-primary); }
        .input-field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px #2563eb60; }
        .loader { border: 4px solid #4b5563; border-top: 4px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border); word-wrap: break-word; vertical-align: top; }
        th { background-color: var(--border); font-weight: 600; }
        tbody tr:hover { background-color: var(--border); }
        
        .list-item { cursor: pointer; transition: background-color 0.2s; }
        .list-item:hover { background-color: #4b5563; }
        .list-item.active { background-color: var(--primary); color: white; }
        .list-item.active h3, .list-item.active p { color: white; }
        
        .article { background-color: #1f2937; padding: 1rem; border-radius: 0.5rem; border: 1px solid #4b5563; margin-bottom: 1rem; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-published { background-color: #10b981; color: #ffffff; }
        .status-draft { background-color: #6b7280; color: #ffffff; }

        .tab-button { background-color: var(--border); color: var(--text-secondary); }
        .tab-button.active { background-color: var(--primary); color: #ffffff; font-weight: 600; }
        .toggle-switch { width: 40px; height: 20px; background-color: #4b5563; border-radius: 10px; position: relative; cursor: pointer; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background-color: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background-color: var(--primary); transform: translateX(20px); }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: var(--sidebar); padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border); }
        .resource-tag { background-color: #374151; color: #9ca3af; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; }
        
        .expandable-content { max-height: 6em; overflow: hidden; transition: max-height 0.3s ease-out; position: relative; }
        .expandable-content.expanded { max-height: 1000px; transition: max-height 0.5s ease-in; }
        .expand-btn { color: var(--primary); cursor: pointer; font-weight: 500; font-size: 0.875rem; margin-top: 4px; }
        
        .color-picker-wrapper { display: flex; align-items: center; gap: 0.5rem; background-color: var(--border); padding: 4px; border-radius: 0.375rem; border: 1px solid #4b5563;}
        .color-well { width: 2.25rem; height: 2.25rem; border: none; padding: 0; background: none; border-radius: 0.25rem; cursor: pointer; -webkit-appearance: none; }
        .color-well::-webkit-color-swatch-wrapper { padding: 0; }
        .color-well::-webkit-color-swatch { border: none; border-radius: 0.25rem; }

        /* Chat styles */
        #chat-messages { display: flex; flex-direction: column; gap: 0.75rem; }
        .chat-bubble { max-width: 75%; padding: 0.75rem 1rem; border-radius: 1rem; line-height: 1.5; word-wrap: break-word; }
        .chat-bubble-user { background-color: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 0.25rem; }
        .chat-bubble-bot { background-color: var(--border); color: var(--text-primary); align-self: flex-start; border-bottom-left-radius: 0.25rem; }
        .typing-indicator { align-self: flex-start; }
        .typing-indicator span { height: 8px; width: 8px; background-color: #9ca3af; border-radius: 50%; display: inline-block; animation: wave 1.3s infinite; }
        .typing-indicator span:nth-of-type(2) { animation-delay: -1.1s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: -0.9s; }
        @keyframes wave { 0%, 60%, 100% { transform: initial; } 30% { transform: translateY(-8px); } }
    </style>
</head>
<body class="h-screen">

    <!-- Login View -->
    <div id="view-login" class="flex items-center justify-center h-screen p-4">
        <div class="w-full max-w-md">
            <div class="card p-8 rounded-lg shadow-lg">
                <div class="text-center mb-8">
                    <i class="fas fa-shield-halved text-blue-400 text-5xl"></i>
                    <h1 class="text-3xl font-bold text-white mt-4">Sales Credential</h1>
                    <p class="text-gray-400">Đăng nhập để bắt đầu xây dựng uy tín.</p>
                </div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="block text-gray-300 mb-2">Email</label>
                        <input type="email" id="email" class="input-field w-full rounded-md p-3" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-300 mb-2">Mật khẩu</label>
                        <input type="password" id="password" class="input-field w-full rounded-md p-3" required>
                    </div>
                    <button type="submit" class="btn-primary w-full rounded-md py-3 font-semibold flex items-center justify-center">Đăng nhập</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App Container (hidden by default) -->
    <div id="app-container" class="hidden h-screen flex flex-col">
        <!-- Header / Horizontal Navigation -->
        <header class="bg-sidebar w-full p-4 shadow-md z-10">
            <div class="container mx-auto flex justify-between items-center">
                <div class="text-2xl font-bold text-blue-400">
                    <i class="fas fa-shield-halved mr-2"></i>
                    <span class="hidden sm:inline">Sales Credential</span>
                </div>
                <div class="flex items-center gap-4 sm:gap-8">
                    <nav class="flex space-x-4 sm:space-x-8">
                        <a href="#" id="nav-chatbot" class="nav-link active py-2 px-1 sm:px-3 text-sm sm:text-base"><i class="fas fa-comments mr-2 hidden sm:inline"></i>Chatbot</a>
                        <a href="#" id="nav-creation" class="nav-link py-2 px-1 sm:px-3 text-sm sm:text-base"><i class="fas fa-compass-drafting mr-2 hidden sm:inline"></i>Kiến tạo</a>
                        <a href="#" id="nav-library" class="nav-link py-2 px-1 sm:px-3 text-sm sm:text-base"><i class="fas fa-folder-open mr-2 hidden sm:inline"></i>Bài viết</a>
                        <a href="#" id="nav-scheduler" class="nav-link py-2 px-1 sm:px-3 text-sm sm:text-base"><i class="fas fa-calendar-check mr-2 hidden sm:inline"></i>Định kỳ</a>
                    </nav>
                     <button id="logout-btn" class="flex items-center text-gray-400 hover:text-white transition-colors duration-200">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        <span class="hidden sm:inline">Đăng xuất</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto container mx-auto">
            <!-- This will be populated by JS -->
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const loginView = document.getElementById('view-login');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const mainContent = document.querySelector('main');

        // --- STATE & API CONFIG ---
        let state = {
            user: null,
            guidelines: [],
            deepspyResults: [],
            resources: [],
            campaigns: [],
            articles: [],
            scheduledTasks: [],
            taskLogs: [],
            threadid: null
        };
        const baserowConfig = {
            host: 'https://aibm.store/',
            token: 'OgCRynnWiyriPH8Txo3yFVtX4l69xIrQ',
            tables: {
                user: '807',
                dinhvi: '828',
                thuvien: '829',
                kienthuc: '874',
                chiendich: '833',
                baiviet: '809',
                cron: '808',
                log: '831'
            }
        };

        const mainContentHTML = `
            <div id="view-chatbot">
                 <h1 class="text-3xl font-bold text-white mb-4">Chatbot</h1>
                 <div class="card h-[70vh] flex flex-col p-4">
                    <div id="chat-messages" class="flex-1 overflow-y-auto mb-4 p-2 bg-gray-900 rounded-md">
                        <!-- Chat messages will be appended here -->
                    </div>
                    <div class="flex gap-4">
                        <input type="text" id="chat-input" class="input-field flex-grow rounded-md p-3" placeholder="Nhập câu hỏi của bạn...">
                        <button id="chat-send-btn" class="btn-primary rounded-md px-6 py-3 font-semibold"><i class="fas fa-paper-plane"></i></button>
                    </div>
                 </div>
            </div>
            <div id="view-creation" class="hidden">
                 <h1 class="text-3xl font-bold text-white mb-4">Không gian Kiến tạo</h1>
                <div class="flex border-b border-gray-700 mb-6">
                    <button class="tab-button py-2 px-4 rounded-t-md active" data-tab="creation-profile">1. Định vị</button>
                    <button class="tab-button py-2 px-4 rounded-t-md" data-tab="creation-resource">2. Thư viện</button>
                    <button class="tab-button py-2 px-4 rounded-t-md" data-tab="creation-deepspy">3. Kiến thức</button>
                </div>
                <div id="tab-content-creation-profile" class="tab-pane">
                     <div class="card p-6 rounded-lg">
                         <h2 class="text-xl font-semibold mb-2 text-white">Quét Profile & Định vị Guideline</h2>
                          <p class="text-gray-400 mb-4">Nhập link Facebook để AI phân tích và tạo Guideline thương hiệu.</p>
                          <div class="flex flex-col sm:flex-row gap-4">
                               <input id="profile-url" type="text" class="input-field w-full rounded-md p-3" placeholder="https://facebook.com/...">
                               <button id="profile-scan-btn" class="btn-primary rounded-md px-6 py-3 font-semibold whitespace-nowrap flex items-center justify-center">
                                   <i class="fas fa-crosshairs mr-2"></i><span>Quét Profile</span>
                               </button>
                          </div>
                          <div id="guideline-output" class="mt-4 overflow-x-auto">
                               <table class="min-w-full">
                                   <thead><tr><th>URL</th><th>Phân tích & Phong cách</th><th>Hành động</th></tr></thead>
                                   <tbody id="guideline-table-body"></tbody>
                               </table>
                          </div>
                     </div>
                </div>
                <div id="tab-content-creation-resource" class="tab-pane hidden">
                     <div class="card p-6 rounded-lg">
                         <div class="mb-8">
                             <h2 class="text-xl font-semibold mb-2 text-white">1. Nhập Testimonial từ Khách hàng</h2>
                             <p class="text-gray-400 mb-4">Tải lên ảnh chụp màn hình tin nhắn, email... làm bằng chứng uy tín.</p>
                             <div class="flex flex-col sm:flex-row gap-4">
                                 <input id="testimonial-upload-input" type="file" accept="image/*" multiple class="block w-full text-sm text-gray-400 file:mr-4 file:py-3 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-gray-300 hover:file:bg-gray-600 flex-grow"/>
                                 <button id="testimonial-import-btn" class="btn-primary rounded-md px-6 py-3 font-semibold whitespace-nowrap"><i class="fas fa-upload mr-2"></i>Import</button>
                             </div>
                         </div>
                          <div id="resource-output" class="mt-4 overflow-x-auto">
                               <table class="min-w-full">
                                   <thead><tr><th>Loại</th><th>Ảnh xem trước</th><th>Chủ đề / Tên file</th><th>Bài viết trang cá nhân gợi ý</th><th>Hành động</th></tr></thead>
                                   <tbody id="resource-table-body"></tbody>
                               </table>
                          </div>
                     </div>
                </div>
                <div id="tab-content-creation-deepspy" class="tab-pane hidden">
                     <div class="card p-6 rounded-lg">
                          <div class="mb-8">
                             <h2 class="text-xl font-semibold mb-2 text-white">1. Tự nhập tài liệu PDF</h2>
                             <p class="text-gray-400 mb-4">Tải lên các tài liệu, báo cáo... làm kiến thức nền.</p>
                             <div class="flex flex-col sm:flex-row gap-4">
                                 <input id="pdf-upload-input" type="file" accept=".pdf" multiple class="block w-full text-sm text-gray-400 file:mr-4 file:py-3 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-gray-300 hover:file:bg-gray-600 flex-grow"/>
                                 <button id="pdf-import-btn" class="btn-primary rounded-md px-6 py-3 font-semibold whitespace-nowrap"><i class="fas fa-upload mr-2"></i>Import PDF</button>
                             </div>
                         </div>
                          <div id="deepspy-output" class="mt-4 overflow-x-auto">
                               <table class="min-w-full">
                                   <thead><tr><th>Nguồn</th><th>Bài viết trang cá nhân gợi ý</th><th>Tên file</th><th>Hành động</th></tr></thead>
                                   <tbody id="deepspy-table-body"></tbody>
                               </table>
                          </div>
                     </div>
                </div>
            </div>
            <div id="view-library" class="hidden">
                 <h1 class="text-3xl font-bold text-white mb-6">Bài viết</h1>
                 <div id="library-content">
                     <div id="library-list-view">
                         <div class="card p-6 rounded-lg mb-6">
                             <div class="flex flex-col gap-4">
                                  <input id="campaign-name" type="text" class="input-field flex-grow rounded-md p-3" placeholder="Nhập tên chiến dịch mới...">
                                  <select id="guideline-selector" class="input-field w-full rounded-md p-3"></select>
                                  <select id="knowledge-selector" class="input-field w-full rounded-md p-3"></select>
                                  <div class="flex items-center gap-4">
                                     <button id="create-campaign-btn" class="btn-primary rounded-md px-6 py-3 font-semibold whitespace-nowrap self-start"><i class="fas fa-plus mr-2"></i>Tạo Chiến dịch</button>
                                     <label class="flex items-center space-x-2 text-gray-300">
                                         <input type="checkbox" id="campaign-google-search-toggle" class="form-checkbox bg-gray-800 border-gray-600 text-blue-500 h-5 w-5">
                                         <span>Duyệt Google Search để gợi ý bài viết</span>
                                     </label>
                                  </div>
                             </div>
                         </div>
                         <div class="card rounded-lg overflow-hidden">
                             <div id="campaign-list" class="space-y-2 p-4"></div>
                         </div>
                     </div>
                     <div id="library-detail-view" class="hidden"></div>
                 </div>
            </div>
            <div id="view-scheduler" class="hidden">
                 <h1 class="text-3xl font-bold text-white mb-6">Định kỳ</h1>
                 <div id="scheduler-content">
                     <div id="scheduler-list-view">
                         <div class="card p-6 rounded-lg mb-6">
                              <h2 class="text-xl font-semibold mb-2 text-white">Thêm nhiệm vụ theo dõi Website</h2>
                              <p class="text-gray-400 mb-4">Nhập vào link web, hệ thống sẽ định kỳ quét link đó có gì mới không.</p>
                              <div class="flex flex-col sm:flex-row gap-4">
                                 <input id="task-url-input" class="input-field flex-grow p-3 rounded-md" placeholder="https://www.example.com/news">
                                 <select id="task-frequency" class="input-field p-3 rounded-md">
                                     <option value="Hàng ngày">Hàng ngày</option>
                                     <option value="Hàng tuần">Hàng tuần</option>
                                 </select>
                                 <button id="schedule-task-btn" class="btn-primary font-semibold py-3 px-6 rounded-md">Thêm</button>
                              </div>
                         </div>
                         <div class="card rounded-lg overflow-hidden">
                             <table class="min-w-full">
                                 <thead><tr><th>Website đang theo dõi</th><th>Tần suất</th><th>Trạng thái</th></tr></thead>
                                 <tbody id="scheduled-tasks-body"></tbody>
                             </table>
                         </div>
                     </div>
                     <div id="scheduler-detail-view" class="hidden"></div>
                 </div>
            </div>
            <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"><p id="toast-message"></p></div>
        `;

        // --- API HELPER ---
        async function fetchFromBaserow(tableId) {
            const url = `${baserowConfig.host}api/database/rows/table/${tableId}/?user_field_names=true`;
            try {
                const response = await fetch(url, { headers: { 'Authorization': `Token ${baserowConfig.token}` } });
                if (!response.ok) {
                    console.error(`API error for table ${tableId}: ${response.statusText}`);
                    return [];
                }
                const data = await response.json();
                return data.results || [];
            } catch (error) {
                console.error(`Failed to fetch from table ${tableId}:`, error);
                showToast(`Lỗi tải dữ liệu từ bảng ${tableId}.`, true);
                return [];
            }
        }

        // --- CHATBOT LOGIC ---
        async function getBotResponse(prompt) {
            const webhookUrl = 'https://aps.aibm.space/webhook/sales1';
            const payload = {
                task: 'chatbot',
                prompt: prompt,
                email: state.user.email,
                threadid: state.threadid,
                depart: '' // Phòng ban của người dùng (chưa có dữ liệu)
            };

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`Webhook response was not ok: ${response.statusText}`);
                }
                const data = await response.json();
                return data[0]?.output || "Xin lỗi, tôi không thể xử lý yêu cầu này.";
            } catch (error) {
                console.error('Error calling webhook:', error);
                return "Đã xảy ra lỗi khi kết nối với bot. Vui lòng thử lại sau.";
            }
        }

        function addMessageToChat(message, sender, isHtml = false) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer) return;
            
            // Clear initial message if it exists
            const initialMessage = messagesContainer.querySelector('.initial-message');
            if(initialMessage) initialMessage.remove();

            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble', `chat-bubble-${sender}`);
            if (isHtml) {
                bubble.innerHTML = message;
            } else {
                bubble.textContent = message;
            }

            messagesContainer.appendChild(bubble);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function handleSendMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            if (!message) return;

            addMessageToChat(message, 'user');
            chatInput.value = '';
            chatInput.disabled = true;

            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-bubble chat-bubble-bot typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.appendChild(typingIndicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            const botReply = await getBotResponse(message);
            
            // Remove typing indicator and add bot reply
            typingIndicator.remove();
            addMessageToChat(botReply, 'bot');
            chatInput.disabled = false;
            chatInput.focus();
        }


        // --- DATA LOADING & MAPPING ---
        async function loadDataForUser(userEmail) {
            mainContent.innerHTML = '<div class="flex justify-center items-center h-full"><div class="loader"></div></div>';
            
            const [dinhvi, thuvien, kienthuc, chiendich, baiviet, cron, log] = await Promise.all([
                fetchFromBaserow(baserowConfig.tables.dinhvi),
                fetchFromBaserow(baserowConfig.tables.thuvien),
                fetchFromBaserow(baserowConfig.tables.kienthuc),
                fetchFromBaserow(baserowConfig.tables.chiendich),
                fetchFromBaserow(baserowConfig.tables.baiviet),
                fetchFromBaserow(baserowConfig.tables.cron),
                fetchFromBaserow(baserowConfig.tables.log)
            ]);

            const userFilter = (item) => item.user && item.user.some(u => u.value === userEmail);

            state.guidelines = dinhvi.filter(userFilter).map(item => ({
                id: item.id,
                url: item['fb url'],
                notes: item.Notes, 
            }));

            state.resources = thuvien.filter(userFilter).map(item => ({
                id: item.id,
                type: 'Ảnh',
                source: 'upload',
                query: item.keyword,
                images: item.files.map(file => ({ url: file.url, name: file.visible_name })),
                content: item.caption,
            }));
            
            state.deepspyResults = kienthuc.filter(userFilter).map(item => ({
                 id: item.id,
                 source: 'upload',
                 fileName: item.files.length > 0 ? item.files[0].visible_name : item.keyword,
                 content: item.caption,
            }));
            
            state.articles = baiviet.map(item => ({
                id: item.id,
                title: item.title,
                status: item.status,
                schedule: item.time,
                content: item.content,
                resources: item.resource.map(r => r.id),
                campaignId: item.chiendich.length > 0 ? item.chiendich[0].id : null,
            }));
            
            state.campaigns = chiendich.filter(userFilter).map(item => ({
                id: item.id,
                name: item.Name,
                guidelineId: item.dinhvi.length > 0 ? item.dinhvi[0].id : null,
                articles: state.articles.filter(a => a.campaignId === item.id)
            }));
            
            state.taskLogs = log.map(item => ({
                id: item.id,
                taskId: item.cron.length > 0 ? item.cron[0].id : null,
                time: new Date(item['Created on']).toLocaleString('vi-VN'),
                status: '<span class="text-green-400">Hoàn thành</span>',
                content: item.Notes
            }));

            state.scheduledTasks = cron.filter(userFilter).map(item => ({
                id: item.id,
                url: item.url,
                frequency: item.frequency,
                active: item.active
            }));
            
            mainContent.innerHTML = mainContentHTML;
            switchView('chatbot');
            renderAll();
            attachAppEventListeners();
        }
        
        // --- RENDER FUNCTIONS ---
        function renderAll() {
            renderGuidelineTable();
            renderResourceTable();
            renderDeepSpyTable();
            renderCampaignList();
            renderScheduledTasksTable();
            renderGuidelineSelector();
            renderKnowledgeSelector();
        }

        function renderExpandableContent(content) {
            if (!content) return '';
            const limit = 100;
            if (content.length <= limit) return `<div>${content.replace(/\n/g, '<br>')}</div>`;
            return `<div><div class="expandable-content">${content.replace(/\n/g, '<br>')}</div><button class="expand-btn">[Xem thêm]</button></div>`;
        }

        function renderGuidelineTable() { 
            const body = document.getElementById('guideline-table-body');
            if (!body) return;
            body.innerHTML = state.guidelines.map(g => `
                <tr>
                    <td>${g.url}</td>
                    <td>${renderExpandableContent(g.notes)}</td>
                    <td>
                        <div class="flex gap-4">
                           <button class="delete-btn text-red-400 hover:text-red-300" data-type="guideline" data-id="${g.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`).join(''); 
        }

        function renderResourceTable() {
            const body = document.getElementById('resource-table-body');
            if (!body) return;
            body.innerHTML = state.resources.map(r => `
                <tr>
                    <td><span class="font-semibold px-2 py-1 rounded bg-green-800 text-green-300">${r.type}</span></td>
                    <td>
                        <div class="flex flex-wrap gap-2">
                            ${r.images.map(img => `<img src="${img.url}" alt="${img.name}" class="w-20 h-12 object-cover rounded">`).join('')}
                        </div>
                    </td>
                    <td>${renderExpandableContent(r.query)}</td>
                    <td>${renderExpandableContent(r.content)}</td>
                    <td>
                        <div class="flex gap-4">
                           <button class="delete-btn text-red-400 hover:text-red-300" data-type="resource" data-id="${r.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`).join('');
        }

        function renderDeepSpyTable() { 
            const body = document.getElementById('deepspy-table-body');
            if(!body) return;
            body.innerHTML = state.deepspyResults.map(r => `
                <tr>
                    <td><span class="font-semibold px-2 py-1 rounded bg-green-800 text-green-300">Upload</span></td>
                    <td>${renderExpandableContent(r.content)}</td>
                    <td>${renderExpandableContent(r.fileName)}</td>
                    <td>
                         <div class="flex gap-4">
                           <button class="delete-btn text-red-400 hover:text-red-300" data-type="deepspy" data-id="${r.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`).join(''); 
        }
        
        function renderCampaignList() {
            const list = document.getElementById('campaign-list');
            if(!list) return;
            list.innerHTML = state.campaigns.map(campaign => `
                <div class="list-item p-4 rounded-lg" data-campaign-id="${campaign.id}">
                    <h3 class="font-bold">${campaign.name}</h3>
                    <p class="text-sm text-gray-400">${campaign.articles.length} bài viết</p>
                </div>
            `).join('');
        }
        
        function renderArticlesForCampaign(campaignId) {
            const campaign = state.campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            const detailView = document.getElementById('library-detail-view');
            if(!detailView) return;
            detailView.innerHTML = `
                <button class="mobile-back-btn btn-primary mb-4 py-2 px-4 rounded-md"><i class="fas fa-arrow-left mr-2"></i> Quay lại</button>
                <h2 class="text-2xl font-bold text-white mb-4">${campaign.name}</h2>
                <div class="space-y-4">
                    ${campaign.articles.map(article => `
                         <div class="article">
                             <p class="font-semibold text-white">${article.title}</p>
                             <div class="mt-2 flex items-center justify-between">
                                 <span class="status-badge ${article.status === 'Đã đăng' ? 'status-published' : 'status-draft'}">${article.status}</span>
                                 <input type="datetime-local" class="input-field text-sm p-1 rounded-md bg-gray-800" value="${article.schedule ? new Date(article.schedule).toISOString().slice(0, 16) : ''}">
                             </div>
                             ${article.content ? `<div class="text-gray-300 mt-4">${renderExpandableContent(article.content)}</div>` : ''}
                         </div>`).join('') || '<p class="text-gray-400">Chưa có bài viết nào trong chiến dịch này.</p>'}
                </div>`;
        }
        
        function renderScheduledTasksTable() {
             const body = document.getElementById('scheduled-tasks-body');
             if (!body) return;
             body.innerHTML = state.scheduledTasks.map(task => `
                <tr class="list-item" data-task-id="${task.id}">
                    <td>${task.url}</td>
                    <td>${task.frequency}</td>
                    <td>
                        <label class="toggle-switch">
                          <input type="checkbox" data-task-id="${task.id}" ${task.active ? 'checked' : ''}>
                          <span class="slider"></span>
                        </label>
                    </td>
                </tr>`).join('');
        }

        function renderLogsForTask(taskId) {
            const task = state.scheduledTasks.find(t => t.id === taskId);
            const detailView = document.getElementById('scheduler-detail-view');
            if (!task || !detailView) return;
            const logs = state.taskLogs.filter(log => log.taskId === taskId);
            detailView.innerHTML = `
                <button class="mobile-back-btn btn-primary mb-4 py-2 px-4 rounded-md"><i class="fas fa-arrow-left mr-2"></i> Quay lại</button>
                <h2 class="text-2xl font-bold text-white mb-4">Logs cho: ${task.url}</h2>
                <div class="space-y-4">
                     ${logs.length > 0 ? logs.map(log => `<div class="article !p-3"><p class="text-sm text-gray-400">${log.time} - ${log.status}</p><div class="text-white mt-1">${renderExpandableContent(log.content)}</div></div>`).join('') : `<p class="text-gray-500">Không có log nào.</p>`}
                </div>`;
        }

        function renderGuidelineSelector() {
            const selector = document.getElementById('guideline-selector');
            if (!selector) return;
            selector.innerHTML = `<option value="">Chọn Guideline Định vị</option>` + state.guidelines.map(g => `<option value="${g.id}">${g.url}</option>`).join('');
        }
        function renderKnowledgeSelector() {
            const selector = document.getElementById('knowledge-selector');
            if (!selector) return;
            selector.innerHTML = `<option value="">Chọn Kiến thức nền</option>` + state.deepspyResults.map(k => `<option value="${k.id}">${k.fileName}</option>`).join('');
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            if(!toast) return;
            toast.querySelector('p').textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 3000);
        }

        // --- EVENT LISTENERS & APP START ---
        function attachAppEventListeners() {
            document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(e.target.id.replace('nav-', ''));
            }));
            
            document.getElementById('logout-btn')?.addEventListener('click', () => {
                localStorage.removeItem('loggedInUser');
                showToast('Đã đăng xuất.');
                appContainer.classList.add('hidden');
                loginView.classList.remove('hidden');
                loginForm.reset();
                mainContent.innerHTML = '';
            });
            
            mainContent.addEventListener('click', (e) => {
                const expandBtn = e.target.closest('.expand-btn');
                if (expandBtn) {
                    const content = expandBtn.previousElementSibling;
                    content.classList.toggle('expanded');
                    expandBtn.textContent = content.classList.contains('expanded') ? '[Thu gọn]' : '[Xem thêm]';
                }

                document.querySelectorAll('#view-creation .tab-button').forEach(button => {
                    if (button.contains(e.target)) {
                         document.querySelectorAll('#view-creation .tab-button').forEach(btn => btn.classList.remove('active'));
                         button.classList.add('active');
                         document.querySelectorAll('#view-creation .tab-pane').forEach(content => content.classList.add('hidden'));
                         document.getElementById(`tab-content-${button.dataset.tab}`).classList.remove('hidden');
                    }
                });
                
                const campaignHeader = e.target.closest('#library-list-view .list-item');
                if (campaignHeader) {
                    document.getElementById('library-list-view').classList.add('hidden');
                    document.getElementById('library-detail-view').classList.remove('hidden');
                    renderArticlesForCampaign(parseInt(campaignHeader.dataset.campaignId));
                }

                const taskItem = e.target.closest('#scheduler-list-view .list-item');
                if (taskItem) {
                    document.getElementById('scheduler-list-view').classList.add('hidden');
                    document.getElementById('scheduler-detail-view').classList.remove('hidden');
                    renderLogsForTask(parseInt(taskItem.dataset.taskId));
                }

                const backBtn = e.target.closest('.mobile-back-btn');
                if(backBtn) {
                    if (document.getElementById('library-detail-view')?.contains(backBtn)) {
                        document.getElementById('library-detail-view').classList.add('hidden');
                        document.getElementById('library-list-view').classList.remove('hidden');
                    }
                     if (document.getElementById('scheduler-detail-view')?.contains(backBtn)) {
                        document.getElementById('scheduler-detail-view').classList.add('hidden');
                        document.getElementById('scheduler-list-view').classList.remove('hidden');
                    }
                }
                
                const chatSendBtn = e.target.closest('#chat-send-btn');
                if (chatSendBtn) {
                    handleSendMessage();
                }
            });
            
            mainContent.addEventListener('keydown', (e) => {
                if (e.target.id === 'chat-input' && e.key === 'Enter') {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
        }
        
        function switchView(viewName) {
            const views = { chatbot: 'view-chatbot', creation: 'view-creation', library: 'view-library', scheduler: 'view-scheduler' };
            Object.values(views).forEach(id => document.getElementById(id)?.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(views[viewName])?.classList.remove('hidden');
            document.getElementById(`nav-${viewName}`)?.classList.add('active');
        }

        async function initializeApp(user) {
            state.user = user;
            state.threadid = `thread_${user.email}_${new Date().getTime()}`; // Create a unique threadid per session
            await loadDataForUser(user.email);
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const submitButton = loginForm.querySelector('button[type="submit"]');

            const originalButtonHTML = submitButton.innerHTML;
            submitButton.innerHTML = `<div class="loader mx-auto"></div>`;
            submitButton.disabled = true;

            const users = await fetchFromBaserow(baserowConfig.tables.user);
            const foundUser = users.find(user => user.mail === email && user.password === password);

            if (foundUser) {
                const userData = { email: foundUser.mail, name: foundUser.Name };
                localStorage.setItem('loggedInUser', JSON.stringify(userData));
                showToast('Đăng nhập thành công!');
                loginView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                await initializeApp(userData);
            } else {
                showToast('Email hoặc mật khẩu không chính xác.', true);
            }
            submitButton.innerHTML = originalButtonHTML;
            submitButton.disabled = false;
        });

        async function checkLoginStatus() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                loginView.classList.add('hidden');
                appContainer.classList.remove('hidden');
                await initializeApp(JSON.parse(loggedInUser));
            } else {
                loginView.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        }
        
        checkLoginStatus();
    });
    </script>
</body>
</html>



